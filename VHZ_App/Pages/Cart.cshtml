@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@model VHZ_App.Pages.CartModel
@{
    ViewData["Title"] = "Корзина";
}
@section Styles {
    <link rel="stylesheet" href="~/css/catalog.css" />
    <link rel="stylesheet" href="~/css/cart.css" />
}
<p class="otstup" />
<label class="cart-lbl">Корзина</label>
<p class="otstup" />
<p class="otstup" />
<label class="txt-cart">Количество товаров в корзине:</label>
<label class="cart-amount txt-cart">@Model.amount</label>
<label class="cart-amount-sht txt-cart">шт</label>
<br />
@if (@Model.amount == 0)
{
    <h1>Корзина пуста</h1>
    <p></p>
}
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">
        @Model.ErrorMessage
    </div>
}
<p></p>
    @foreach (var cart in Model.CartProducts)
    {
        string way = "/Image/" + @cart.IdProductNavigation.Image;
        <div class="product-card-wrapper">
            <div class="card-catalog">
                <div class="card-content">
                    <div class="image-container">
                        <img src="@way" alt="@cart.IdProductNavigation.NameProduct" class="responsive-image">
                    </div>
                    <div class="text-content">
                        <div class="price-section">
                            <span class="price-per">Цена за 10кг</span>
                            <span class="price">@cart.IdProductNavigation.Price.ToString("#.##") руб</span>
                        </div>
                        <div class="product-info">
                            <h3 class="product-name">@cart.IdProductNavigation.NameProduct</h3>
                            <p class="product-description">@cart.IdProductNavigation.Appointment</p>
                            <p class="product-compliance">@cart.IdProductNavigation.ProductCompliance</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="cart-controls">
            <input type="checkbox"
                   class="check-cart"
                   name="selectedCarts"
                   value="@cart.IdCart" />

            <form method="post" asp-page-handler="DeleteCart" asp-route-idCart="@cart.IdCart">
                <button type="submit" class="cart-remove-btn">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </form>

            <div class="quantity-controls">
                <form method="post" asp-page-handler="MinusAmount" asp-route-idCart="@cart.IdCart">
                    <button type="submit" class="quantity-btn">-</button>
                </form>
                <span class="quantity-value">@cart.AmountProducts</span>
                <form method="post" asp-page-handler="PlusAmount" asp-route-idCart="@cart.IdCart">
                    <button type="submit" class="quantity-btn">+</button>
                </form>
            </div>

            <form method="post" asp-page-handler="BuyProduct" asp-route-idCart="@cart.IdCart">
                <button type="submit" class="buy-now-btn">Купить</button>
            </form>
            <form method="post" asp-page-handler="SelectProduct">
                <input type="hidden" name="idProduct" value="@cart.IdProduct" />
                <button type="submit" class="details-btn">Подробнее</button>
            </form>
        </div>
        <div class="otstup"></div>
    }

    <label class="txt-cart-16">ИТОГО:</label>
    <label class="cart-amount txt-cart-16">@Model.price.ToString("#.##")</label>
    <label class="cart-amount-sht txt-cart-16">руб</label>

<button type="submit" id="submitSelected" class="btn-cart-oform">К оформлению</button>

<label class="end-text"></label>
<p></p>
<form id="selectedItemsForm" method="post" asp-page-handler="BuySelectedCarts" style="display: none;">
    <input type="hidden" name="selectedCartsJson" id="selectedCartsInput" />
</form>

<script>
    document.getElementById('submitSelected').addEventListener('click', function() {
        // Собираем выбранные чекбоксы
        const checkboxes = document.querySelectorAll('.check-cart:checked');
        const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (selectedIds.length === 0) {
            alert('Выберите хотя бы один товар!');
            return;
        }

        // Записываем в скрытое поле и отправляем форму
        document.getElementById('selectedCartsInput').value = JSON.stringify(selectedIds);
        document.getElementById('selectedItemsForm').submit();
    });
</script>